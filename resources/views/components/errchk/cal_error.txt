<x-app-layout>
    <x-slot name="header">
        <h2 class="font-semibold text-xl text-gray-800 leading-tight">
            {{ __('Dashboard') }}
        </h2>
    </x-slot>

    <div class="py-12">
        <style>
            //  calenderç”¨
            a {
                text-decoration: none;
            }
            .calendar-wrap {
                width:58rem;
                background: #eee;
                color: #333;
            }
            .calender_head {
                line-height: 60px;
                text-align: center;
                font-size: 2rem;
            }
            .calender_center {
                width:40%;
                text-align: center;
                font-size: 3rem;
                color:#408040;
                font-weight: bold;
                /*-webkit-text-stroke: 2px #FFF; ç™½æŠœãæ–‡å­—ã¯ã‚‚ã£ã¨å¤§ãã„æ–‡å­—ãŒå¿…è¦ãªã®ã§ãƒ¤ãƒ¡
                text-stroke: 1px #FFF;*/
                text-shadow: 1px 1px 0 #333;
            }
            .calender_link {
                display:static;
                width:30%;
                text-align: center;
            }
            .calender {
                padding:10px;
                font-size:1.2rem;
            }
            .dateBeforLink {
                text-align: center;
                clip-path: polygon(0 10%,81% 10%,80% 0,100% 50%,80% 100%,80% 90%,0 90%,0 10%);
            }
            .dateAfterLink {
                text-align: center;
                clip-path: polygon(0 50%,15% 0%,15% 15%,100% 15%,100% 75%,15% 75%,15% 100%,0 50%);
            }
            .calender th,td {
                border:2px solid #408040;
            }		
            .calender th {
                height: 30px;
                width: 8rem;
                text-align: center;
            }
            .calender td {
                height: 6rem;
                vertical-align: top;
            }
            .calender th:nth-of-type(1), td:nth-of-type(1) {    /* æ—¥æ›œæ—¥ */
                background: #fee;
                color: red;
            }
            .calender th:nth-of-type(7), td:nth-of-type(7) {    /* åœŸæ›œæ—¥ */
                background: #eef;
                color: blue;
            }
            .today {
                background: orange !important;
            }
            /* â– â– â– â– â–  ï¼‘æ—¥ã®æ  â– â– â– â– â–  */
            .area {
                display: grid;
                grid-template-areas:
                    "date edit"
                    "names names"
                    "cnt yoyaku";
                grid-gap: 10px;
                border: 1px solid #ccc;
                padding: 1px 1px 4px 1px;
            }
            .day {
                grid-area: date;
                width: 3rem;
                text-align: center;
                font-size:1.2rem;
                /*background: rgb(157, 237, 200);*/
                background-image: linear-gradient(to right, rgb(157, 237, 200), rgb(255, 255, 255));
            }
            .day_today {
                grid-area: date;
                width: 3rem;
                text-align: center;
                font-size:1.2rem;
                font-weight: bold;
                background: rgb(57, 137, 100);
            }
            .edit_dummy {   /* ç®¡ç†è€…ä»¥å¤–ã¯ç·¨é›†ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹ */
                grid-area: edit;
            }
            .edit_button {   /* ç®¡ç†è€…ç”¨ã®ç·¨é›†ãƒœã‚¿ãƒ³ */
                grid-area: edit;
                width: 2.5rem;
                text-align: center;
                font-size:0.8rem;
                background: rgb(128, 206, 128);
            }
            .yoyaku_cnt {
                grid-area: cnt;
                width: 2.5rem;
                text-align: center;
                font-size:0.8rem;
                background: rgb(232, 206, 224);
            }
            .yoyaku_cnt::before {
                content: "æ®‹";
                font-size:0.5rem;
            }
            .names {
                grid-area: names;
                min-height: 100px;
                font-size:0.6rem;
            }
            .yoyaku_button {
                grid-area: yoyaku;
                height: 1.2rem;
                width: 100%;
                vertical-align: bottom;
                background-color: #c8c480;
                color: black;
                border: 1px solid #008440;
                text-align: center;
                text-decoration: none;
                font-size: 0.8rem;
                display: inline-block;     
                clip-path: polygon(0 10%,81% 10%,80% 0,100% 50%,80% 100%,80% 90%,0 90%,0 10%);       
            }
            yoyaku_button:hover {  /* ãƒã‚¦ã‚¹ãƒ›ãƒãƒ¼æ™‚ã®çŠ¶æ…‹ */
                background-color: #3e8e41;
            }
            yoyaku_button:active { /* æŠ¼ä¸‹æ™‚ã®çŠ¶æ…‹ */
                background-color: #3e8e41;
                box-shadow: 0 5px #666;
                transform: translateY(4px);
            }
            .arrow-left {
                position :relative;
                top: 1rem;
                padding: 0.6rem;
                height: 3.5rem;
                width: 100%;
                text-align': center;
                vertical-align: middle;
                background-color: #c8c480;
                color: black;
                border: 1px solid #008440;
                text-align: center;
                font-size: 1.4rem;
                display: inline-block;     
                clip-path: polygon(10% 50%,20% 0%,20% 20%,90% 20%,90% 80%,20% 80%,20% 100%,10% 50%);
            }
            .text-center {
                font-size: 2.0rem;
                background-color: #f0f0f0;
                padding: 20px;
                border: 1px solid #008440;
                border-radius: 15px;                
                text-stroke: 1px #FFF;*/
                text-shadow: 1px 1px 0 #333;
            }
            .weekday {
                font-size: 1.4rem;
                transform: scaleX(2);
            }
            .arrow-right {
                position :relative;
                top: 1rem;
                padding: 0.6rem;
                height: 3.5rem;
                width: 100%;
                text-align': center;
                vertical-align: middle;
                background-color: #c8c480;
                color: black;
                border: 1px solid #008440;
                text-align: center;
                font-size: 1.4rem;
                display: inline-block;     
                clip-path: polygon(10% 20%,80% 20%,80% 0,90% 50%,80% 90%,80% 80%,10% 80%,10% 20%);       
            }
        </style>    

        @livewireStyles

        <div class="card">
            <div class="card-header" style="text-align: center;">
                - äºˆç´„ -
            </div>
            <!-- livewire:shopclosedmodal /-->
            @livewireScripts
            
            <div class="card-body">
                <ul>
                    <li>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚ˆã‚Šã€ã”å¸Œæœ›ã®äºˆç´„æ—¥ã‚’ãŠé¸ã³ãã ã•ã„ã€‚</li>
                    <li>äºˆç´„æ—¥ã¯æ¬¡å›äºˆç´„ã®ã¿ãŠå–ã‚Šã„ãŸã ã‘ã¾ã™ã€‚</li>
                </ul>

                <div class="calender">
                    <form class="prev-next-form"></form>
                    <table class="calender">
                        <thead>
                        <tr>
                            <td colspan="2">
                                <label  class="arrow-left">
                                    <a href="#" class="dateBeforLink" id="date_befor_link" onclick="GetYoyakuCalender( '{{ calendar_culc($month,-1) }}' )">å‰æœˆ</a>
                                </label>
                            </td>
                            <th colspan="3">
                                <label  class="text-center" id="date_month">
                                    {{ date('Y',strtotime($month)) }}å¹´{{ date('m', strtotime($month)) }}æœˆ
                                </label>
                            </th>
                            <td colspan="2">
                                <label  class="arrow-right">
                                    <a href="#" class="dateAfterLink" id="date_after_link" onclick="GetYoyakuCalender( '{{ calendar_culc($month,+1) }}' )">æ¬¡æœˆ</a>
                                </label>
                            </td>
                        </tr>
                        <tr>
                            <th class="sun"><div class="weekday">æ—¥</div></th>
                            <th class="mon"><div class="weekday">æœˆ</div></th>
                            <th class="tue"><div class="weekday">ç«</div></th>
                            <th class="wed"><div class="weekday">æ°´</div></th>
                            <th class="thu"><div class="weekday">æœ¨</div></th>
                            <th class="fri"><div class="weekday">é‡‘</div></th>
                            <th class="sat"><div class="weekday">åœŸ</div></th>
                        </tr>
                        </thead>
                        <tbody id="calenderTable">
                        </tbody>
                    </table>

                    <script>
                    var CurrYM = '{{ $month }}';
                    const today= new Date();
                    const todayYY = today.getFullYear();
                    const todayMM = ('0' + (today.getMonth() + 1)).slice(-2); // æœˆã¯0ã‹ã‚‰å§‹ã¾ã‚‹ãŸã‚+1ã—ã€æ¡æ•°ã‚’2æ¡ã«èª¿æ•´
                    const todayDD = ('0' + today.getDate()).slice(-2);

                    GetYoyakuCalender(CurrYM);  //  åˆå›ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤º
                    function calendar_culc(reqYM,numMonth){
                        // DateTimeã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
                        const [year, month] = reqYM.split('-');
                        const date = new Date(year, month - 1, 1);

                        // å‰ã®æœˆã®æœ«æ—¥ã‚’å–å¾—
                        date.setMonth(date.getMonth() + numMonth);
                        const lastDayOfPreviousMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0);

                        // å¹´ã¨æœˆã‚’å–å¾—
                        const previousYear = lastDayOfPreviousMonth.getFullYear();
                        const previousMonth = lastDayOfPreviousMonth.getMonth() + 1;

                        return `${previousYear}-${previousMonth.toString().padStart(2, '0')}`;
                    }

                    function GetYoyakuCalender(reqYM) {
                        CurrYM = reqYM;
                        const [reqYY, reqMM, reqDD] = reqYM.split('-');
                        chkDD = 0;
                        if((reqYY == todayYY) && (reqMM == todayMM)) {
                            chkDD = todayDD;
                        }

                        // æ—¢å­˜ã®tbodyè¦ç´ ã‚’å‰Šé™¤
                        const tbody = document.getElementById('calenderTable'); // idãŒ'calenderTable'ã®tbodyè¦ç´ ã‚’æƒ³å®š
                        while (tbody.firstChild) {    // tbodyã®å­è¦ç´ ãŒãªããªã‚‹ã¾ã§ãƒ«ãƒ¼ãƒ—
                            tbody.removeChild(tbody.firstChild);
                        }
                        document.getElementById('date_month').textContent = reqYY + 'å¹´ã€€' + reqMM + 'æœˆ';

                        // å‰æœˆã¸ã®ãƒªãƒ³ã‚¯ã‚’æ›¸ãæ›ãˆ
                        const dateBeforLink = document.getElementById('date_befor_link');
                        dateBeforLink.onclick = function() {
                            var strLink = calendar_culc( reqYM,-1);
                            GetYoyakuCalender(strLink);
                        };

                        // æ¬¡æœˆã¸ã®ãƒªãƒ³ã‚¯ã‚’æ›¸ãæ›ãˆ
                        const dateAfterLink = document.getElementById('date_after_link');
                        dateAfterLink.onclick = function() {
                            var strLink = calendar_culc( reqYM,+1);
                            GetYoyakuCalender(strLink);
                        };

                        let clsAry = ["sun","mon","tue","wed","thu","fri","sat"];
                        var calendarDiv = document.getElementById('calenderTable');
                        /*  var calendarAry =  @#json($calender); å‘¼ã³å‡ºã—å…ƒã‹ã‚‰ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—*/
                        const maxYoyaku = 16;
                        $.ajax({
                            url: '{{ route('reserve.calenderGet') }}', // ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹URL
                            type: 'GET',
                            data: {
                                type    : '1',
                                month   : reqYM
                            },                            
                            success: function(response) {
                                // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è¿”ã£ã¦ããŸãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†
                                console.log(response);

                                calendarAry = response;

                                var weekStr=""; //  ç·¨é›†å…ˆæ–‡å­—åˆ—
                                var dayIx = 0;
                                var weekIx = 0;
                                const template = document.createElement('template');
                                calendarAry.forEach(function(weekAry) {

                                    weekStr="<tr>"; //  ç·¨é›†å…ˆæ–‡å­—åˆ—
                                    dayIx = 0;
                                    weekAry.forEach(function(dayInfo) {     //  ä¸€é€±é–“åˆ†ã¥ã¤ç·¨é›†
                                        weekStr+='<td><div class="area">';

                                        if(dayInfo.day > 0) {
                                            if(dayInfo.day == chkDD) {
                                                weekStr += '<div class="day_today">' + dayInfo.day + '</div>';
                                            } else {
                                                weekStr += '<div class="day">' + dayInfo.day + '</div>';
                                            }
                                            var zanSeki = maxYoyaku - dayInfo.totalCnt;
                                            @auth
                                                //weekStr += '<button class="cnt" id="Yoyaku' + dayInfo.day + 
                                                //           '" onclick="openYoyakuInput(' + dayInfo.day + 
                                                //           ')">zanSeki</button>';
                                                weekStr += '<button class="edit_button" onclick=\'openEditModal("' + dayInfo.day + '")\'>ç·¨é›†</button>';
                                            @else    
                                                weekStr += '<div class="edit_dummy">ã€€</div>';
                                            @endauth

                                            weekStr += '<div class="names">';   //  äºˆç´„è€…ãƒªã‚¹ãƒˆ
                                            if(dayInfo.totalCnt > 0) {
                                                //  äºˆç´„è€…ãŒã„ã‚‹å ´åˆã€åå‰ãƒ»äººæ•°ã¨ãƒªãƒ³ã‚¯ã‚’è¿½åŠ 
                                                var memCnt = 0;
                                                dayInfo.member.forEach(function(member) {
                                                    if(memCnt > 0) {
                                                        weekStr += '<br>';
                                                    }
                                                    weekStr += member.name + ':' + member.cnt;
                                                    memCnt++;
                                                })
                                            }
                                            else {
                                                weekStr += "ã€€ã€€ã€€ã€€ã€€";
                                            }
                                            weekStr += '</div>';
                                            weekStr += '<div class="yoyaku_cnt">' + zanSeki + '</div>';
                                    
                                            if(dayInfo.day > chkDD) {   //  æ˜æ—¥ä»¥é™ãªã‚‰ã°äºˆç´„ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                                                weekStr += '<button class="yoyaku_button" id="Yoyaku' + dayInfo.day + 
                                                           '" onclick="openYoyakuInput(' + dayInfo.day + ')" ';  
                                                if(zanSeki <= 0) {
                                                    weekStr += 'disabled';
                                                }
                                                weekStr += '>äºˆç´„</button>';  
                                            }
                                        }

                                        //  æ ã®çµ‚ã‚ã‚Š
                                        weekStr+='</div></td>';
                                        dayIx++;
                                    })
                                    weekStr+='</tr>';
                                    template.innerHTML = weekStr;
                                    content = template.content;
                                    calendarDiv.appendChild(content);
                                    weekIx++;
                                })
                            },
                            error: function(error) {
                                // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã®å‡¦ç†
                                console.error(error);
                            }
                        });
                    }
                    function openYoyakuInput(day) {
                        //  YYYY-MM-DD ã«ç·¨é›†
                        var reqDate = CurrYM.substr(0,8) + ('00' + day).slice(-2);

                        //  æ–°è¦ç”»é¢ã¸ã®URL
                        const newUrl = '{{ Route('reserve.create') }}/' + reqDate;
                        window.location.href = newUrl;            // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                    }
                    //  æŒ‡å®šæ—¥ã®æƒ…å ±ã‚’èª­ã¿å–ã‚Š
                    function readDateInfo() {
                        var reqDate = CurrYM.substr(0,8) + ('00' + day).slice(-2);

                        $.ajax({
                            url: '{{ route('reserve.readDateInfo') }}', // ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹URL
                            type: 'GET',
                            data: {
                                type    : '1',
                                month   : reqDate
                            },                            
                            success: function(response) {
                                // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è¿”ã£ã¦ããŸãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†
                                console.log(response);
                                dateinfo = response;
                            },
                            error: function(error) {
                                // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã®å‡¦ç†
                                console.error(error);
                            }
                        });
                    }
                    //  æŒ‡å®šæ—¥ã®æƒ…å ±ã‚’æ›¸ãè¾¼ã‚€
                    function writeDateInfo() {
                        var reqDate = CurrYM.substr(0,8) + ('00' + day).slice(-2);

                        let jsonData = '{"name": "å¤ªéƒ", "age": 30}';
                        let jsonObj = JSON.parse(jsonData);


                        $.ajax({
                            url: '{{ route('reserve.writeDateInfo') }}', // ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹URL
                            type: 'GET',
                            data: {
                                type    : '1',
                                month   : reqDate
                            },                            
                            success: function(response) {
                                // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è¿”ã£ã¦ããŸãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†
                                console.log(response);

                                dateinfo = response;
                            },
                            error: function(error) {
                                // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã®å‡¦ç†
                                console.error(error);
                            }
                        });
                    }
                    
                    </script>
                    <!-- modalã‚¤ãƒ¡ãƒ¼ã‚¸ã®å®šç¾© -->
                    <style>
                        .modal {
                            display: none;
                            position: fixed;
                            z-index: 1;
                            left: 0;
                            top: 0;
                            height: 100%;
                            width: 100%;
                            overflow: auto;
                            background-color: rgba(0,0,0,0.5);
                        }

                        .modal-content {
                            background-color: #f4f4f4;
                            margin: 20% auto;
                            width: 50%;
                            box-shadow: 0 5px 8px 0 rgba(0,0,0,0.2),0 7px 20px 0 rgba(0,0,0,0.17);
                            animation-name: modalopen;
                            animation-duration: 1s;
                        }

                        @keyframes modalopen {
                            from {opacity: 0}
                            to {opacity: 1}
                        }

                        .modal-header h1 {
                            margin: 1rem 0;
                        }

                        .modal-header {
                            background: lightblue;
                            padding: 3px 15px;
                            display: flex;
                            justify-content: space-between;
                        }

                        .modalClose {
                            font-size: 2rem;
                        }

                        .modalClose:hover {
                            cursor: pointer;
                        }

                        .modal-body {
                            padding: 10px 20px;
                            color: black;
                        }
                    </style>
                    <div id="easyModal" class="modal">
                        <div class="modal-content">
                            <div class="modal-header" id="modal-header">
                                <label id="dateCaption">Great job ğŸ‰</label>
                                <span class="modalClose" onclick="modalClose()">Ã—</span>
                            </div>
                            <div class="modal-body">
                                å–¶æ¥­çŠ¶æ…‹ï¼š<select id="eigyosts">
                                    <option value="1">é€šå¸¸å–¶æ¥­</option>
                                    <option value="2">ä¼‘æ¥­</option>
                                    <option value="3">è²¸ã—åˆ‡ã‚Š</option>
                                </select><br>
                                äºˆç´„æ¸ˆäººæ•°ï¼š<input type="number" min="1" max="10" step="1">
                                <hr>
                                <x-primary-button class="mt-4" id="applysts"ã€€onclick="writeDateInfo()">é©ç”¨</x-primary-button>
                            </div>
                        </div>
                    </div>
                    <script>
                        const editModal = document.getElementById('easyModal');
                        function openEditModal(strDate) {
                            content = CurrYM.substr(0, 7) + '-' +  ('00' + strDate).slice(-2);
                            headDiv = document.getElementById('dateCaption');
                            headDiv.textContent = content;
                            readDateInfo(content);

                            editModal.style.display = 'block';
                        }
                        function modalClose() {
                            editModal.style.display = 'none';
                        }                            
                    </script>
                </div>
            </div>
        </div>
    </div>
</x-app-layout>
